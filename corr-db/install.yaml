---
- name: install mongodb
  apt:
    name: "{{ item }}"
    state: present
    force: yes
  become: true
  with_items:
    - mongodb

- name: install required corrdb packages
  shell: "{{ conda }} env update -n {{ corr_env }} --file {{ corr_path }}/corr-db/requirements.yaml"

- name: install corrdb
  shell: "{{ env_path }}/python setup.py install"
  args:
    chdir: "{{ corr_path }}/corr-db"

- name: check import corrdb
  shell: "{{ python }} -c \"import corrdb\""
  args:
    chdir: "{{ corr_path }}/corr-db"

- name: start mongodb
  service: name=mongodb state=started
  become: true

- name: wait for mongodb to become available
  wait_for:
    port: 27017

- name: run the corrdb tests
  shell: "{{ env_path }}/python -c \"import corrdb; corrdb.test()\""
  args:
    chdir: "{{ corr_path }}/corr-db"
  async: 1000
  poll: 0
