## Deploy a production environment using Nginx

- name: create ~/.config directory
  file: path={{ local_path }}/.config state=directory

- name: copy gunicorn template
  template: src={{ inventory_dir }}/app_config.py.j2 dest={{ local_path}}/.config/{{ gunicorn_config_file }}

- name: copy service template
  template: src={{ inventory_dir }}/app.service.j2 dest=/lib/systemd/system/{{ app_service_name }}.service
  become: true

- name: update systemd
  command: systemctl daemon-reload
  become: true

- name: run server
  service: name={{ app_service_name }} state=restarted
  become: true

- name: copy nginx template
  template: src={{ inventory_dir }}/nginx-app.j2 dest=/etc/nginx/sites-available/{{ app_service_name }}
  become: true

- name: link files for nginx
  file: src=/etc/nginx/sites-available/{{ app_service_name }} dest=/etc/nginx/sites-enabled/{{ app_service_name }} state=link
  become: true

- name: restart nginx
  service: name=nginx state=restarted
  become: true

- name: check that app is up and running
  uri: url={{ test_path }}
